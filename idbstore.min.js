/*
 IDBWrapper - A cross-browser wrapper for IndexedDB
 Copyright (c) 2011 - 2013 Jens Arps
 http://jensarps.de/

 Licensed under the MIT (X11) license
*/
(function(j,i,k){"function"===typeof define?define(i):"undefined"!==typeof module&&module.exports?module.exports=i():k[j]=i()})("IDBStore",function(){var j={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:function(a){throw a;},indexes:[]},i=function(a,d){"undefined"==typeof d&&"function"==typeof a&&(d=a);"[object Object]"!=Object.prototype.toString.call(a)&&(a={});for(var b in j)this[b]="undefined"!=typeof a[b]?a[b]:j[b];this.dbName=
this.storePrefix+this.storeName;this.dbVersion=parseInt(this.dbVersion,10)||1;b="object"==typeof window?window:self;this.idb=b.indexedDB||b.webkitIndexedDB||b.mozIndexedDB;this.keyRange=b.IDBKeyRange||b.webkitIDBKeyRange||b.mozIDBKeyRange;this.features={hasAutoIncrement:!b.mozIndexedDB};this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"};var c,e;this.ready=new Promise(function(a,
b){c=a;e=b});this.onStoreReady=function(){c()};this.onError=function(){e()};this.openDB()};i.prototype={constructor:i,version:"1.4.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var a=this.idb.open(this.dbName,this.dbVersion),d=!1;a.onerror=function(a){var c=!1;"error"in a.target?c="VersionError"==a.target.error.name:"errorCode"in a.target&&(c=12==a.target.errorCode);
if(c)this.onError(Error("The version number provided is lower than the existing one."));else this.onError(a)}.bind(this);a.onsuccess=function(a){if(!d)if(this.db)this.onStoreReady();else if(this.db=a.target.result,"string"==typeof this.db.version)this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));else if(this.db.objectStoreNames.contains(this.storeName)){this.store=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName);
var c=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var b=a.name;b?(this.normalizeIndexData(a),this.hasIndex(b)?(this.indexComplies(this.store.index(b),a)||(d=!0,this.onError(Error('Cannot modify index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),c.splice(c.indexOf(b),1)):(d=!0,this.onError(Error('Cannot create new index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")))):(d=!0,this.onError(Error("Cannot create index: No index name given.")))},
this);c.length&&(d=!0,this.onError(Error('Cannot delete index(es) "'+c.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")));d||this.onStoreReady()}else this.onError(Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."))}.bind(this);a.onupgradeneeded=function(a){this.db=a.target.result;if(this.db.objectStoreNames.contains(this.storeName))this.store=a.target.transaction.objectStore(this.storeName);else{a={autoIncrement:this.autoIncrement};
if(null!==this.keyPath)a.keyPath=this.keyPath;this.store=this.db.createObjectStore(this.storeName,a)}var c=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(a){var b=a.name;b||(d=!0,this.onError(Error("Cannot create index: No index name given.")));this.normalizeIndexData(a);this.hasIndex(b)?(this.indexComplies(this.store.index(b),a)||(this.store.deleteIndex(b),this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})),c.splice(c.indexOf(b),1)):this.store.createIndex(b,
a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})},this);c.length&&c.forEach(function(a){this.store.deleteIndex(a)},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)},put:function(a,d){return new Promise(function(b,c){null!==this.keyPath&&(d=a);var e=!1,g=null,f;f=this.db.transaction([this.storeName],this.consts.READ_WRITE);f.oncomplete=function(){(e?b:c)(g)};f.onabort=c;f.onerror=c;null!==this.keyPath?(this._addIdPropertyIfNeeded(d),f=f.objectStore(this.storeName).put(d)):
f=f.objectStore(this.storeName).put(d,a);f.onsuccess=function(a){e=!0;g=a.target.result};f.onerror=c}.bind(this))},get:function(a){return new Promise(function(d,b){var c=!1,e=null,g=this.db.transaction([this.storeName],this.consts.READ_ONLY);g.oncomplete=function(){(c?d:b)(e)};g.onabort=b;g.onerror=b;g=g.objectStore(this.storeName).get(a);g.onsuccess=function(a){c=!0;e=a.target.result};g.onerror=b}.bind(this))},remove:function(a){return new Promise(function(d,b){var c=!1,e=null,g=this.db.transaction([this.storeName],
this.consts.READ_WRITE);g.oncomplete=function(){(c?d:b)(e)};g.onabort=b;g.onerror=b;g=g.objectStore(this.storeName)["delete"](a);g.onsuccess=function(a){c=!0;e=a.target.result};g.onerror=b}.bind(this))},batch:function(a){return new Promise(function(d,b){"[object Array]"!=Object.prototype.toString.call(a)&&b(Error("dataArray argument must be of type Array."));var c=this.db.transaction([this.storeName],this.consts.READ_WRITE);c.oncomplete=function(){(f?d:b)(f)};c.onabort=b;c.onerror=b;var e=a.length,
g=!1,f=!1,h=function(){e--;0===e&&!g&&(f=g=!0)};a.forEach(function(a){var d=a.type,e=a.key,f=a.value,a=function(a){c.abort();g||(g=!0,b(a,d,e))};if("remove"==d)f=c.objectStore(this.storeName)["delete"](e),f.onsuccess=h,f.onerror=a;else if("put"==d)null!==this.keyPath?(this._addIdPropertyIfNeeded(f),f=c.objectStore(this.storeName).put(f)):f=c.objectStore(this.storeName).put(f,e),f.onsuccess=h,f.onerror=a},this)}.bind(this))},putBatch:function(a){return this.batch(a.map(function(a){return{type:"put",
value:a}}))},removeBatch:function(a){return this.batch(a.map(function(a){return{type:"remove",key:a}}))},getBatch:function(a,d){return new Promise(function(b,c){d||(d="sparse");"[object Array]"!=Object.prototype.toString.call(a)&&c(Error("keyArray argument must be of type Array."));var e=this.db.transaction([this.storeName],this.consts.READ_ONLY);e.oncomplete=function(){(h?b:c)(l)};e.onabort=c;e.onerror=c;var g=[],f=a.length,h=!1,l=null,i=function(a){a.target.result||"dense"==d?g.push(a.target.result):
"sparse"==d&&g.length++;f--;0===f&&(h=!0,l=g)};a.forEach(function(a){a=e.objectStore(this.storeName).get(a);a.onsuccess=i;a.onerror=function(a){l=a;c(a);e.abort()}},this)}.bind(this))},getAll:function(){var a=this.db.transaction([this.storeName],this.consts.READ_ONLY),d=a.objectStore(this.storeName);return d.getAll?this._getAllNative(a,d):this._getAllCursor(a,d)},_getAllNative:function(a,d){return new Promise(function(b,c){var e=!1,g=null;a.oncomplete=function(){(e?b:c)(g)};a.onabort=c;a.onerror=
c;var f=d.getAll();f.onsuccess=function(a){e=!0;g=a.target.result};f.onerror=c}.bind(this))},_getAllCursor:function(a,d){return new Promise(function(b,c){var e=[],g=!1,f=null;a.oncomplete=function(){(g?b:c)(f)};a.onabort=c;a.onerror=c;var h=d.openCursor();h.onsuccess=function(a){(a=a.target.result)?(e.push(a.value),a["continue"]()):(g=!0,f=e)};h.reject=c}.bind(this))},clear:function(){return new Promise(function(a,d){var b=!1,c=null,e=this.db.transaction([this.storeName],this.consts.READ_WRITE);e.oncomplete=
function(){(b?a:d)(c)};e.onabort=d;e.onerror=d;e=e.objectStore(this.storeName).clear();e.onsuccess=function(a){b=!0;c=a.target.result};e.onerror=d}.bind(this))},_addIdPropertyIfNeeded:function(a){!this.features.hasAutoIncrement&&"undefined"==typeof a[this.keyPath]&&(a[this.keyPath]=this._insertIdCount++ +Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(a){return this.store.indexNames.contains(a)},normalizeIndexData:function(a){a.keyPath=a.keyPath||a.name;a.unique=
!!a.unique;a.multiEntry=!!a.multiEntry},indexComplies:function(a,d){return["keyPath","unique","multiEntry"].every(function(b){if("multiEntry"==b&&void 0===a[b]&&!1===d[b])return!0;if("keyPath"==b&&"[object Array]"==Object.prototype.toString.call(d[b])){var b=d.keyPath,c=a.keyPath;if("string"==typeof c)return b.toString()==c;if(!("function"==typeof c.contains||"function"==typeof c.indexOf)||c.length!==b.length)return!1;for(var e=0,g=b.length;e<g;e++)if(!(c.contains&&c.contains(b[e])||c.indexOf(-1!==
b[e])))return!1;return!0}return d[b]==a[b]})},iterate:function(a,d){return new Promise(function(b,c){d=m({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null},d||{});var e="desc"==d.order.toLowerCase()?"PREV":"NEXT";d.filterDuplicates&&(e+="_NO_DUPLICATE");var g=!1,f=this.db.transaction([this.storeName],this.consts[d.writeAccess?"READ_WRITE":"READ_ONLY"]),h=f.objectStore(this.storeName);d.index&&(h=h.index(d.index));f.oncomplete=function(){g?b():c(null)};
f.onabort=c;f.onerror=c;e=h.openCursor(d.keyRange,this.consts[e]);e.onerror=c;e.onsuccess=function(b){if(b=b.target.result){if(a(b.value,b,f),d.autoContinue)b["continue"]()}else g=!0}}.bind(this))},query:function(a){var a=a||{},d=[];return this.iterate(function(a){d.push(a)},a).then(function(){return Promise.resolve(d)})},count:function(a,d){var d=m({index:null,keyRange:null},d||{}),b=d.reject,c=!1,e=null,g=this.db.transaction([this.storeName],this.consts.READ_ONLY);g.oncomplete=function(){(c?a:b)(e)};
g.onabort=b;g.onerror=b;var f=g.objectStore(this.storeName);d.index&&(f=f.index(d.index));f=f.count(d.keyRange);f.onsuccess=function(a){c=!0;e=a.target.result};f.reject=b;return g},makeKeyRange:function(a){var d="undefined"!=typeof a.lower,b="undefined"!=typeof a.upper,c="undefined"!=typeof a.only;switch(!0){case c:a=this.keyRange.only(a.only);break;case d&&b:a=this.keyRange.bound(a.lower,a.upper,a.excludeLower,a.excludeUpper);break;case d:a=this.keyRange.lowerBound(a.lower,a.excludeLower);break;
case b:a=this.keyRange.upperBound(a.upper,a.excludeUpper);break;default:throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.');}return a}};var k={},m=function(a,d){var b,c;for(b in d)c=d[b],c!==k[b]&&c!==a[b]&&(a[b]=c);return a};i.version=i.prototype.version;return i},this);
